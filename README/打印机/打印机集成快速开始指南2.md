# 打印机集成快速开始指南

## ⚠️ Node.js 版本要求

**重要**：本项目需要 **Node.js v18.20.8**。当前检测到你的 Node.js 版本是 v24.11.1，不兼容。

### 切换到 Node.js v18.20.8

#### 方法 1: 使用 nvm-windows（推荐）

1. **安装 nvm-windows**：
   - 下载：https://github.com/coreybutler/nvm-windows/releases
   - 下载 `nvm-setup.exe` 并安装

2. **安装 Node.js v18.20.8**：
   ```powershell
   # 安装指定版本
   nvm install 18.20.8
   
   # 切换到该版本
   nvm use 18.20.8
   
   # 验证版本
   node -v
   # 应该显示: v18.20.8
   ```

3. **设置默认版本**（可选）：
   ```powershell
   nvm alias default 18.20.8
   ```

#### 方法 2: 使用 fnm (Fast Node Manager)

1. **安装 fnm**：
   ```powershell
   # 使用 Chocolatey
   choco install fnm
   
   # 或使用 Scoop
   scoop install fnm
   ```

2. **安装并使用 Node.js v18.20.8**：
   ```powershell
   # 安装指定版本
   fnm install 18.20.8
   
   # 切换到该版本
   fnm use 18.20.8
   
   # 验证版本
   node -v
   ```

#### 方法 3: 直接下载安装

1. **下载 Node.js v18.20.8**：
   - 访问：https://nodejs.org/dist/v18.20.8/
   - 下载 Windows 安装包（.msi）

2. **安装并替换当前版本**

3. **验证安装**：
   ```powershell
   node -v
   # 应该显示: v18.20.8
   ```

### 切换版本后

切换 Node.js 版本后，**必须重新安装依赖**：

```powershell
# 删除现有的 node_modules
Remove-Item -Recurse -Force node_modules -ErrorAction SilentlyContinue

# 删除 package-lock.json（可选，但推荐）
Remove-Item package-lock.json -ErrorAction SilentlyContinue

# 重新安装依赖
npm install
```

---

## 前置要求（Windows 用户）

**重要**：`ffi-napi` 等包需要编译原生 C++ 代码，Windows 用户必须先安装构建工具。

### 安装 Visual Studio Build Tools 和 Windows SDK

#### 情况 1: 尚未安装 Visual Studio Build Tools

1. **下载 Visual Studio Installer**：
   - 访问：https://visualstudio.microsoft.com/downloads/
   - 下载 "Build Tools for Visual Studio 2022"

2. **安装必要组件**：
   - 运行 Visual Studio Installer
   - 选择 "使用 C++ 的桌面开发"（Desktop development with C++）工作负载
   - **确保勾选以下组件**：
     - ✅ MSVC v143 - VS 2022 C++ x64/x86 生成工具
     - ✅ Windows 10 SDK（或 Windows 11 SDK，选择最新版本）
     - ✅ C++ CMake 工具（可选但推荐）

#### 情况 2: 已安装 Visual Studio Build Tools，但缺少 Windows SDK（当前情况）

根据错误信息，你已经安装了 Visual Studio 2022 Build Tools，但缺少 Windows SDK。按以下步骤添加：

1. **打开 Visual Studio Installer**：
   - 在开始菜单搜索 "Visual Studio Installer"
   - 或者运行：`C:\Program Files (x86)\Microsoft Visual Studio\Installer\vs_installer.exe`

2. **修改现有安装**：
   - 找到 "Visual Studio Build Tools 2022"
   - 点击 **"修改"** 按钮

3. **添加 Windows SDK**：
   - 在 "使用 C++ 的桌面开发" 工作负载下
   - 展开 "可选组件" 或 "单个组件" 标签
   - **找到并勾选以下组件**：
     - ✅ **Windows 10 SDK (10.0.22621.0)** 或更高版本
     - ✅ **Windows 11 SDK**（如果有，选择最新版本）
   - 如果找不到，在右侧搜索框搜索 "Windows SDK"

4. **完成安装**：
   - 点击右下角 "修改" 按钮
   - 等待安装完成（可能需要几分钟到十几分钟）

5. **验证安装**：
   安装完成后，**必须重新打开 PowerShell**（关闭当前窗口，重新打开），然后运行：
   ```bash
   npm install ffi-napi ref-napi ref-struct-napi ref-array-napi
   ```

> **注意**：`better-sqlite3` 和 `ffi-napi` 等原生模块都需要 Windows SDK 才能编译。如果安装依赖时仍然报错 "missing any Windows SDK"，请确保已按照上述步骤安装 Windows SDK。

#### 快速检查 Windows SDK 是否已安装

在 PowerShell 中运行以下命令检查：

```powershell
# 检查 Windows SDK 路径
dir "C:\Program Files (x86)\Windows Kits\10\Include" -ErrorAction SilentlyContinue
```

如果命令返回目录列表，说明已安装；如果报错，说明未安装。

### 如果仍然遇到问题

#### 方法 1: 使用管理员权限运行

```powershell
# 以管理员身份运行 PowerShell，然后执行：
npm install ffi-napi ref-napi ref-struct-napi ref-array-napi
```

#### 方法 2: 清理缓存后重试

```powershell
# 清理 npm 缓存
npm cache clean --force

# 删除 node_modules（如果存在）
Remove-Item -Recurse -Force node_modules -ErrorAction SilentlyContinue

# 重新安装
npm install ffi-napi ref-napi ref-struct-napi ref-array-napi
```

#### 方法 3: 手动设置环境变量

如果 Windows SDK 已安装但 node-gyp 找不到，可以手动设置：

```powershell
# 查找 Windows SDK 版本（在 PowerShell 中运行）
$sdkPath = Get-ChildItem "C:\Program Files (x86)\Windows Kits\10\Include" -ErrorAction SilentlyContinue | Sort-Object Name -Descending | Select-Object -First 1
if ($sdkPath) {
    Write-Host "找到 Windows SDK: $($sdkPath.Name)"
    $env:WindowsSDKDir = "C:\Program Files (x86)\Windows Kits\10"
    npm install ffi-napi ref-napi ref-struct-napi ref-array-napi
} else {
    Write-Host "未找到 Windows SDK，请先安装"
}
```

#### 方法 4: 使用预编译的二进制文件（高级）

如果编译仍然失败，可以尝试使用 `windows-build-tools`：

```powershell
npm install --global windows-build-tools
```

然后重新安装依赖。

#### 方法 5: 临时使用模拟模式（不推荐，仅用于测试）

如果暂时无法安装构建工具，系统会在模拟模式下运行（不会实际打印，但不会报错）。代码中已经包含了错误处理，即使 `ffi-napi` 未安装，系统也能正常运行，只是不会调用真实的打印机 DLL。

---

## 第一步：安装依赖

在 `queueSystem-server` 目录下运行：

```bash
npm install ffi-napi ref-napi ref-struct-napi ref-array-napi
```

## 第二步：放置 DLL 文件

将打印机 SDK 提供的 DLL 文件复制到以下位置之一：

1. **推荐**: `queueSystem-server/printer_sdk/PrinterSDK.dll`
2. **或者**: 任意位置，然后设置环境变量 `PRINTER_DLL_PATH`

## 第三步：配置 DLL 函数

1. 打开 `queueSystem-server/services/printerService.js`

2. 找到 DLL 路径配置（约第 30 行）：
   ```javascript
   const DLL_PATH = process.env.PRINTER_DLL_PATH || './printer_sdk/PrinterSDK.dll';
   ```
   修改为你的 DLL 实际路径和文件名。

3. 找到函数签名定义（约第 40 行）：
   ```javascript
   const printerLib = ffi.Library(DLL_PATH, {
     // 在这里添加你的 DLL 函数
   });
   ```

4. 根据你的 DLL 函数签名添加函数定义。例如：
   ```javascript
   const printerLib = ffi.Library(DLL_PATH, {
     'PrintTicket': ['int', ['string', 'string', 'int']],
   });
   ```

5. 在 `printTicket` 函数中（约第 80 行），取消注释并修改实际的函数调用：
   ```javascript
   const result = printerDll.PrintTicket(
     ticket_number,
     business_type_name,
     waiting_count
   );
   
   if (result === 0) {
     return { success: true, message: '打印成功' };
   } else {
     return { success: false, message: `打印失败，错误代码: ${result}` };
   }
   ```

## 第四步：测试

1. 启动服务器：
   ```bash
   npm run dev
   ```

2. 在取票页面取一张票，系统会自动调用打印机。

3. 查看控制台日志，确认打印是否成功。

## 常见 DLL 函数签名示例

### 示例 1: 简单打印函数
```javascript
// C++: int PrintTicket(const char* ticketNumber, const char* businessType, int waitingCount);
const printerLib = ffi.Library(DLL_PATH, {
  'PrintTicket': ['int', ['string', 'string', 'int']],
});
```

### 示例 2: Unicode 字符串
```javascript
// C++: int PrintTicket(const wchar_t* ticketNumber, const wchar_t* businessType, int waitingCount);
const printerLib = ffi.Library(DLL_PATH, {
  'PrintTicket': ['int', ['wstring', 'wstring', 'int']],
});
```

### 示例 3: 带初始化函数
```javascript
const printerLib = ffi.Library(DLL_PATH, {
  'InitPrinter': ['int', []],
  'PrintTicket': ['int', ['string', 'string', 'int']],
  'ClosePrinter': ['int', []],
});
```

然后在 `initPrinter` 函数中：
```javascript
const result = printerDll.InitPrinter();
return result === 0;
```

## 需要帮助？

查看详细文档：`printer_example/README.md`

