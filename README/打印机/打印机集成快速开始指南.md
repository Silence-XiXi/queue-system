# 打印机集成快速开始指南

## 一、确认文件结构

确保以下文件存在：
```
queueSystem-server/
├── printer_sdk/
│   ├── CsnPrinterLibs.dll    ← 打印机 DLL 文件
│   ├── CsnPrinterLibs.lib
│   └── PrinterLibs.h
├── services/
│   ├── printerService.js     ← 打印机服务（已完善）
│   └── ticketService.js       ← 取票服务（已集成打印）
└── index.js                   ← 服务器入口（已添加打印机初始化）
```

## 二、安装依赖

在 `queueSystem-server` 目录下执行：

```bash
npm install ffi-napi ref-napi ref-struct-napi ref-array-napi
```

**注意**: 这些依赖已经在 `package.json` 中，通常只需要运行 `npm install` 即可。

## 三、配置打印机

### 最简单的方式：修改环境变量

**Windows PowerShell:**
```powershell
# 串口打印机示例（COM1, 9600波特率）
$env:PRINTER_PORT_TYPE="COM"
$env:PRINTER_PORT_NAME="COM1"
$env:PRINTER_BAUDRATE="9600"

# 启动服务器
node index.js
```

**Windows CMD:**
```cmd
set PRINTER_PORT_TYPE=COM
set PRINTER_PORT_NAME=COM1
set PRINTER_BAUDRATE=9600
node index.js
```

### 其他端口类型示例

**USB 打印机:**
```powershell
$env:PRINTER_PORT_TYPE="USB"
$env:PRINTER_PORT_NAME="USB001"
```

**网络打印机:**
```powershell
$env:PRINTER_PORT_TYPE="TCP"
$env:PRINTER_PORT_NAME="192.168.1.100"
$env:PRINTER_TCP_PORT="9100"
```

**禁用打印机（测试模式）:**
```powershell
$env:PRINTER_ENABLED="false"
```

## 四、启动服务器

```bash
node index.js
```

### 成功标志

如果看到以下输出，说明打印机已正确配置：

```
✅ 打印机 DLL 加载成功: ...\printer_sdk\CsnPrinterLibs.dll
   打印机配置: { ... }
✅ 打印机端口打开成功: COM:COM1
✅ 打印机初始化成功
```

### 如果看到警告

**警告 1**: `打印机 DLL 加载失败，将使用模拟模式`
- **原因**: DLL 文件未找到或依赖未安装
- **解决**: 检查 DLL 文件路径，运行 `npm install`

**警告 2**: `无法打开端口 XXX`
- **原因**: 打印机未连接或端口名称错误
- **解决**: 检查打印机连接，确认端口名称

## 五、测试打印

1. **打开取票页面**: `http://localhost:3000/ticket`
2. **选择业务类型并取票**
3. **查看控制台输出**:
   ```
   ✅ 打印成功: { ticket_number: 'A001', ... }
   ```
4. **检查打印机**: 应该已经打印出纸质票

## 六、打印内容说明

打印的票包含以下信息：
- 标题：排队票号（大字体）
- 票号：如 A001（超大字体，加粗）
- 业务类型：如 业务办理
- 等待人数：如 5人
- 日期：如 2024/01/01
- 时间：如 14:30:00
- 提示信息：请妥善保管您的票号

## 七、常见问题

### Q1: 如何知道我的打印机端口名称？
**A**: 
- **串口**: 在设备管理器中查看 "端口 (COM 和 LPT)"
- **USB**: 在设备管理器中查看 "通用串行总线控制器" 或使用打印机工具枚举
- **网络**: 查看打印机的 IP 地址设置

### Q2: 打印失败但不影响取票？
**A**: 这是正常设计。打印失败只记录警告，取票流程继续，确保系统可用性。

### Q3: 如何修改打印格式？
**A**: 编辑 `services/printerService.js` 中的 `printTicket` 函数，可以自定义打印内容的布局。

### Q4: 如何测试打印机连接？
**A**: 启动服务器时，如果看到 "打印机端口打开成功"，说明连接正常。

## 八、详细配置

更多配置选项请参考: [PRINTER_CONFIG.md](./PRINTER_CONFIG.md)

## 九、技术支持

如果遇到问题：
1. 查看控制台的错误信息
2. 检查打印机连接和配置
3. 参考 [PRINTER_CONFIG.md](./PRINTER_CONFIG.md) 中的故障排除部分

