# 安装问题排查指南

## npm install 卡住问题

如果 `npm install` 卡住（显示加载动画但无进展），可能是以下原因：

### 1. 正在编译原生模块（正常情况）

`better-sqlite3` 和 `sqlite3` 需要编译 C++ 代码，可能需要 5-15 分钟。请耐心等待。

**如何判断是否在编译**：
- 检查 CPU 使用率是否较高
- 查看是否有 `node-gyp` 相关进程在运行
- 检查 `node_modules` 目录是否在增长

### 2. Windows SDK 缺失导致编译失败

如果 Windows SDK 未安装，编译会失败但可能卡住。

**解决方案**：
1. 按 `Ctrl+C` 中断当前安装
2. 安装 Windows SDK（参考 QUICKSTART.md）
3. 重新安装

### 3. 网络问题

**解决方案**：
```powershell
# 使用国内镜像源
npm config set registry https://registry.npmmirror.com

# 或使用 cnpm
npm install -g cnpm --registry=https://registry.npmmirror.com
cnpm install
```

## 快速诊断步骤

### 步骤 1: 检查 Windows SDK

```powershell
Test-Path "C:\Program Files (x86)\Windows Kits\10\Include"
```

如果返回 `False`，需要先安装 Windows SDK。

### 步骤 2: 检查是否有编译进程

```powershell
# 查看是否有 node-gyp 进程
Get-Process | Where-Object {$_.ProcessName -like "*node*" -or $_.ProcessName -like "*gyp*"}
```

### 步骤 3: 清理后重新安装

```powershell
# 中断当前安装（如果还在运行）
# 按 Ctrl+C

# 清理
Remove-Item -Recurse -Force node_modules -ErrorAction SilentlyContinue
Remove-Item package-lock.json -ErrorAction SilentlyContinue
npm cache clean --force

# 重新安装（使用详细输出）
npm install --verbose
```

### 步骤 4: 分步安装（如果仍然卡住）

```powershell
# 先安装不需要编译的包
npm install --no-optional --ignore-scripts

# 然后单独安装需要编译的包
npm install better-sqlite3 --build-from-source
npm install sqlite3 --build-from-source
```

## 临时解决方案：跳过原生模块

如果暂时不需要数据库功能，可以：

```powershell
# 安装时跳过可选依赖和脚本
npm install --ignore-scripts --no-optional
```

**注意**：这会导致 `better-sqlite3` 和 `sqlite3` 无法使用，但其他功能正常。

## 检查安装进度

在另一个 PowerShell 窗口中运行：

```powershell
# 查看 node_modules 目录大小变化
while ($true) {
    $size = (Get-ChildItem -Path node_modules -Recurse -ErrorAction SilentlyContinue | Measure-Object -Property Length -Sum).Sum / 1MB
    Write-Host "$(Get-Date -Format 'HH:mm:ss') - node_modules 大小: $([math]::Round($size, 2)) MB"
    Start-Sleep -Seconds 5
}
```

如果大小在增长，说明正在安装，请耐心等待。

