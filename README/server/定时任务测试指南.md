# 定时任务测试指南

## 方法一：通过浏览器控制台获取 Token（推荐）

### 步骤 1：登录管理员界面
1. 打开浏览器，访问：`http://localhost:3000/admin/login`
2. 输入默认密码：`admin123`
3. 登录成功后，token 会自动保存到浏览器的 localStorage

### 步骤 2：获取 Token
1. 按 `F12` 打开浏览器开发者工具
2. 切换到 `Console`（控制台）标签
3. 输入以下命令并按回车：
   ```javascript
   localStorage.getItem('adminToken')
   ```
4. 复制返回的 token 值（例如：`YWRtaW5fMTcyMDAwMDAwMDAw`）

### 步骤 3：测试定时任务接口

#### 3.1 查看定时任务状态（无需认证）
在浏览器控制台中输入：
```javascript
fetch('http://localhost:3000/api/admin-system/scheduler/status')
.then(res => res.json())
.then(data => console.log(JSON.stringify(data, null, 2)))
.catch(err => console.error('错误:', err))
```

#### 3.2 测试定时任务（立即执行一次重置）
在浏览器控制台中输入：
```javascript
fetch('http://localhost:3000/api/admin-system/scheduler/test', {
  method: 'POST',
  headers: {
    'Admin-Token': localStorage.getItem('adminToken'),
    'Content-Type': 'application/json'
  }
})
.then(res => res.json())
.then(data => console.log('测试结果:', data))
.catch(err => console.error('错误:', err))
```

#### 3.3 重启定时任务（无需认证）
在浏览器控制台中输入：
```javascript
fetch('http://localhost:3000/api/admin-system/scheduler/restart', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  }
})
.then(res => res.json())
.then(data => console.log('重启结果:', data))
.catch(err => console.error('错误:', err))
```

#### 3.4 手动触发重置（需要认证）
在浏览器控制台中输入：
```javascript
fetch('http://localhost:3000/api/admin-system/scheduler/manual-reset', {
  method: 'POST',
  headers: {
    'Admin-Token': localStorage.getItem('adminToken'),
    'Content-Type': 'application/json'
  }
})
.then(res => res.json())
.then(data => console.log('重置结果:', data))
.catch(err => console.error('错误:', err))
```

---

## 方法二：使用 curl 命令（命令行）

### 步骤 1：登录获取 Token
```bash
curl -X POST http://localhost:3000/api/admin-system/login \
  -H "Content-Type: application/json" \
  -d "{\"password\":\"admin123\"}"
```

返回结果示例：
```json
{
  "message": "登录成功",
  "token": "YWRtaW5fMTcyMDAwMDAwMDAw"
}
```

### 步骤 2：使用 Token 测试接口

#### 2.1 查看定时任务状态（无需认证）
```bash
curl -X GET http://localhost:3000/api/admin-system/scheduler/status
```

#### 2.2 测试定时任务
```bash
curl -X POST http://localhost:3000/api/admin-system/scheduler/test \
  -H "Admin-Token: YOUR_TOKEN_HERE" \
  -H "Content-Type: application/json"
```

#### 2.3 重启定时任务（无需认证）
```bash
curl -X POST http://localhost:3000/api/admin-system/scheduler/restart \
  -H "Content-Type: application/json"
```

#### 2.4 手动触发重置（需要认证）
```bash
curl -X POST http://localhost:3000/api/admin-system/scheduler/manual-reset \
  -H "Admin-Token: YOUR_TOKEN_HERE" \
  -H "Content-Type: application/json"
```

---

## 方法三：使用 Postman 或类似工具

### 步骤 1：登录获取 Token
1. 创建新请求
2. 方法：`POST`
3. URL：`http://localhost:3000/api/admin-system/login`
4. Headers：`Content-Type: application/json`
5. Body（raw JSON）：
   ```json
   {
     "password": "admin123"
   }
   ```
6. 发送请求，复制返回的 `token` 值

### 步骤 2：测试定时任务接口

#### 2.1 查看状态（无需认证）
1. 创建新请求
2. 方法：`GET`
3. URL：`http://localhost:3000/api/admin-system/scheduler/status`
4. 无需 Headers，直接发送请求

#### 2.2 操作接口（需要认证）
1. 创建新请求
2. 方法：`POST`
3. URL：`http://localhost:3000/api/admin-system/scheduler/test`（或其他操作接口）
4. Headers：
   - `Admin-Token: YOUR_TOKEN_HERE`
   - `Content-Type: application/json`
5. 发送请求

---

## 接口说明

### 1. 查看定时任务状态
- **方法**：`GET`
- **路径**：`/api/admin-system/scheduler/status`
- **说明**：返回定时任务的当前状态、重置时间设置、当前时间等信息
- **认证**：**无需认证**，可直接访问（无需 Admin-Token）

### 2. 测试定时任务
- **方法**：`POST`
- **路径**：`/api/admin-system/scheduler/test`
- **说明**：立即执行一次完整的重置流程，用于验证功能是否正常
- **认证**：**需要 Admin-Token**

### 3. 手动触发重置
- **方法**：`POST`
- **路径**：`/api/admin-system/scheduler/manual-reset`
- **说明**：手动执行重置操作，与定时任务执行的内容相同
- **认证**：**需要 Admin-Token**

### 4. 重启定时任务
- **方法**：`POST`
- **路径**：`/api/admin-system/scheduler/restart`
- **说明**：重启定时任务，用于修复定时任务停止等问题
- **认证**：**无需认证**，可直接访问（无需 Admin-Token）

---

## 默认密码

- **默认管理员密码**：`admin123`
- 如果密码已修改，请使用修改后的密码

---

## 常见问题

### Q: Token 无效怎么办？
A: Token 可能已过期，请重新登录获取新的 token。

### Q: 如何修改重置时间？
A: 在管理员设置页面（`/admin/settings`）修改 `ticket_reset_time` 设置，修改后定时任务会自动重启。

### Q: 如何查看定时任务是否正在运行？
A: 使用 `GET /api/admin-system/scheduler/status` 接口查看状态，检查 `isRunning` 字段。

### Q: 定时任务没有执行怎么办？
A: 
1. **检查服务器日志**，查看是否有错误信息
   - 查找 "========== 定时任务触发 ==========" 日志
   - 查找 "定时任务健康检查" 日志
   - 查找任何错误或警告信息

2. **使用状态接口检查定时任务状态**
   - 调用 `GET /api/admin-system/scheduler/status` 查看详细状态
   - 检查 `isRunning`、`cronJobRunning`、`healthCheckActive` 等字段
   - 查看 `expectedNextExecution` 和 `lastExecutionTime`

3. **检查重置时间设置是否正确**
   - 确认 `ticket_reset_time` 设置格式为 "HH:MM"（如 "00:00"）
   - 使用测试接口验证功能是否正常

4. **检查服务器时区设置**
   - 查看日志中的 "当前系统时间" 和 "当前上海时间"
   - 确认系统时区是否正确
   - 如果系统时区不是 Asia/Shanghai，定时任务会使用系统本地时间

5. **检查服务器是否持续运行**
   - 如果服务器在定时任务执行时间之前重启，定时任务需要重新启动
   - 健康检查机制会在检测到问题时自动重启定时任务

6. **手动重启定时任务**
   - 如果发现问题，可以调用 `POST /api/admin-system/scheduler/restart` 重启定时任务

---

## 注意事项

1. **Token 安全性**：当前实现使用简单的 Base64 编码，仅用于开发环境。生产环境应使用 JWT 等更安全的方案。

2. **时区问题**：如果定时任务没有在预期时间执行，可能是时区设置问题。检查服务器时区是否为 `Asia/Shanghai`。

3. **服务器运行**：确保 Node.js 服务器持续运行，如果服务器重启，定时任务需要重新启动。

